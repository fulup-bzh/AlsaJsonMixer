"use strict";function scarletteCapture(a){function b(b,c,d,e){b.matrixSourcesPool=[],b.matrixRoutesPool=[],b.updatePool=function(a,b,c){a[b].used=c;for(var d=0;d<a[b].options.length;d++)a[b].options[d].disabled=c},b.takeLinePool=function(a,c,d){d!==c.value&&b.callback([c.numid],[d]),0==d||a[d].used||b.updatePool(a,d,!0)},b.freeLinePool=function(a,c,d){d!==c.value&&b.updatePool(a,d,!1),0!=d&&b.callback([c.numid],[0])},b.ProcessRouteSource=function(a){var b={name:a.name+" numid="+a.numid,actif:a.actif,numid:a.numid,value:a.value[0],line:a};return b},b.ProcessFader=function(a,b,c){var d={name:a.name+" numid="+a.numid,channel:{numid:a.numid,actif:a.actif,idxin:b,idxout:c},ctrl:{value:a.value,notLess:a.ctrl.min,notMore:a.ctrl.max,byStep:a.ctrl.step}};return d},b.initWidget=function(c){if(c){for(var d=[],e=[],f=[],g=c.sources[1].ctrl.enums,h=0;h<g.length;h++)b.matrixSourcesPool.push({id:h,name:g[h],used:!1,options:[]});for(var h=0;h<c.sources.length;h+=b.faderGroup){for(var i=[],j=[],k=[],l=0;l<b.faderGroup;l++)k.push(h+l+1),j.push(c.sources[h+l].numid),i.push(b.ProcessRouteSource(c.sources[h+l]));var m={uid:"Numid"+JSON.stringify(j),label:"Line "+JSON.stringify(k),name:"Capture Source "+JSON.stringify(k),matrixLinesPool:b.matrixSourcesPool,lines:i};d.push(m)}for(var n=c.routes[1].ctrl.enums,h=0;h<n.length;h++)b.matrixRoutesPool.push({id:h,name:n[h],used:!1,options:[]});for(var h=0;h<c.routes.length;h+=+b.faderGroup){for(var i=[],j=[],k=[],l=0;l<b.faderGroup;l++)k.push(h+l+1),j.push(c.routes[h+l].numid),i.push(b.ProcessRouteSource(c.routes[h+l]));var m={uid:"Numid"+JSON.stringify(j),label:"Route "+JSON.stringify(k),name:"Playback Route "+JSON.stringify(k),matrixLinesPool:b.matrixRoutesPool,lines:i};e.push(m)}for(var h=0;h<c.mixes.length;h+=b.mixerGroup){for(var o=[],p=[],l=0;l<b.mixerGroup;l++)o.push(c.mixes[h+l].name);for(var l=0;l<c.mixes[h].volumes.length;l+=b.faderGroup){for(var q=[],r=l;r<l+b.faderGroup;r++){for(var s=[],t=h;t<h+b.mixerGroup;t++)s.push(b.ProcessFader(c.mixes[t].volumes[r],r-l,t-h));q.push(s)}p.push(q)}var m={name:"Mix:"+o.toString(),mixvol:p};f.push(m)}b.matrixSources=d,b.matrixRoutes=e,b.matrixMixVols=f,a.log("matrixMixVolsMix=",f)}},b.MatrixSourcesPoolCB={take:function(a,c){b.takeLinePool(b.matrixSourcesPool,a,c)},free:function(a,c){b.freeLinePool(b.matrixSourcesPool,a,c)}},b.MatrixRoutesPoolCB={take:function(a,c){b.takeLinePool(b.matrixRoutesPool,a,c)},free:function(a,c){b.freeLinePool(b.matrixRoutesPool,a,c)}},b.ActivateCtrlsCB=function(c,d){a.log("scarletteCapture CB numids=%j value=%d",c,d),b.callback(c,[d])},b.mixerGroup=parseInt(d.mixerGroup)||2,b.faderGroup=parseInt(d.faderGroup)||2,b.$watch("initvalues",function(){b.initvalues&&b.initWidget(b.initvalues)})}return{templateUrl:"partials/scarlett-capture.html",scope:{callback:"=",initvalues:"="},restrict:"E",link:b}}function scarlettMaster(a){function b(b,c,d){b.selectElem=c[0].firstChild,b.initWidget=function(a){b.switches=a.switches;for(var c=[],d=0;d<a.volumes.length;d++)c.push(b.ProcessVolume(a.volumes[d],d));b.volumes=c},b.ProcessVolume=function(a,b){var c={name:a.name+" numid="+a.numid,channel:{numid:a.numid,actif:a.actif,idx:b,count:a.ctrl.count},ctrl:{value:a.value[0]||a.value,notLess:a.ctrl.min,notMore:a.ctrl.max,byStep:a.ctrl.step}};return c},b.ActivateCtrlsCB=function(c,d){a.log("scarlettMaster CB numids=%j value=%d",[c],d),b.callback([c],d)},b.switchid=d.id|"switch-"+parseInt(1e3*Math.random()),b.$watch("initvalues",function(){b.initvalues&&b.initWidget(b.initvalues)})}return{templateUrl:"partials/scarlett-master.html",scope:{callback:"=",initvalues:"="},restrict:"E",link:b}}function ScarlettController(a,b,c){var d=this;d.getControls=function(){var a={request:"ctrl-get-all",cardid:d.cardid},b=c.get("/jsonapi",{params:a});b.success(function(a,b,c,e){d.sndcard=a.sndcard;var f=[],g=[],h=[],i=[],j=[],k=[],l=[],m=[];if("AJG_ctrls"!=a.ajgtype)return void alert("AJM:FATAL ScarlettMixerController sndcard="+d.cardid+", response="+JSON.stringify(a));for(var n=a.data,o=0;o<n.length;o++){var p=n[o],q=p.name.toLowerCase().split(" ");if("input"===q[0]&&"capture"===q[3]&&f.push(p),"matrix"===q[0]&&"playback"==q[3]&&h.push(p),"matrix"===q[0]&&"mix"===q[2]&&"volume"==q[5]){var r=q[3];g[r]||(g[r]={name:r.toUpperCase(),volumes:[]}),g[r].volumes.push(p)}"master"===q[0]&&"switch"===q[q.length-1]&&i.push(p),"master"===q[0]&&"volume"===q[q.length-1]&&l.push(p),"master"===q[0]&&"enum"===q[q.length-1]&&m.push(p),"input"===q[0]&&"pad"==q[2]&&k.push(p),"input"===q[0]&&"impedance"===q[2]&&j.push(p)}var s=[];g&&Object.keys(g).forEach(function(a,b){s.push(g[a])},g),d.alsamixer={sources:f,routes:h,mixes:s},d.alsamaster={volumes:l,sources:m,switches:{master:i,pad:k,impedance:j}}}),b.error(function(a,b,c){alert("Fail to get Card Controls from AlsaJsonGateway")})},d.SendAlsaCtrlsCB=function(a,b){var e={request:"ctrl-set-many",cardid:d.cardid,numids:JSON.stringify(a),args:JSON.stringify(b)},f=c.get("/jsonapi",{params:e});f.success(function(a,b,c,d){}),f.error(function(a,b,c){alert("Fail to send Card Controls to AlsaJsonGateway")})},d.init=function(){d.cardid=b.search().card,d.getControls()},d.init()}ngapp.addDirective("scarlettCapture",["$log",scarletteCapture]),ngapp.addDirective("scarlettMaster",["$log",scarlettMaster]),ngapp.addController("ScarlettMixerController",["$log","$location","$http",ScarlettController]);