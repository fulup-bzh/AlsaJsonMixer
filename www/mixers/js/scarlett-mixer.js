"use strict";function scarletteCapture(a,r){return{templateUrl:"partials/scarlett-capture.html",scope:{callback:"=",initvalues:"="},restrict:"E",link:function(v,e,s,t){v.updatePool=function(e,s,t){e[s].used=t;for(var a=0;a<e[s].options.length;a++)e[s].options[a].disabled=t},v.takeLinePool=function(e,s,t){t!==s.value&&v.callback([s.numid],[t]),0!=t&&v.updatePool(e,t,!0)},v.freeLinePool=function(e,s,t){a.log("free pool",s),0!=t&&v.updatePool(e,t,!1),0!=t&&v.callback([s.numid],[0])},v.ProcessRouteSource=function(e){return{name:e.name+" numid="+e.numid,actif:e.actif,numid:e.numid,value:e.value[0],line:e}},v.ProcessFader=function(e,s,t,a){return{name:e.name+" numid="+e.numid,channel:{numid:e.numid,actif:e.actif,idxin:s,idxout:t,mixgrp:a},ctrl:{value:e.value,notLess:e.ctrl.min,notMore:e.ctrl.max,byStep:e.ctrl.step}}},v.initWidget=function(e){if(e){var s=[],t=[],a=[];v.matrixSourcesPool=[],v.matrixRoutesPool=[];for(var r=e.sources[1].ctrl.enums,o=0;o<r.length;o++)v.matrixSourcesPool.push({id:o,name:r[o],used:!1,options:[]});for(o=0;o<e.sources.length;o+=v.faderGroup){for(var i=[],n=[],u=[],l=0;l<v.faderGroup;l++)u.push(o+l+1),n.push(e.sources[o+l].numid),i.push(v.ProcessRouteSource(e.sources[o+l]));var c={uid:"Numid"+JSON.stringify(n),label:"Capture "+JSON.stringify(u),name:"Capture Source "+JSON.stringify(u),matrixLinesPool:v.matrixSourcesPool,lines:i};s.push(c)}for(var d=e.routes[1].ctrl.enums,o=0;o<d.length;o++)v.matrixRoutesPool.push({id:o,name:d[o],used:!1,options:[]});for(o=0;o<e.routes.length;o+=+v.faderGroup){for(i=[],n=[],u=[],l=0;l<v.faderGroup;l++)u.push(o+l+1),n.push(e.routes[o+l].numid),i.push(v.ProcessRouteSource(e.routes[o+l]));c={uid:"Numid"+JSON.stringify(n),label:"Input "+JSON.stringify(u),name:"Playback Route "+JSON.stringify(u),matrixLinesPool:v.matrixRoutesPool,lines:i};t.push(c)}for(o=0;o<e.mixes.length;o+=v.mixerGroup){for(var m=[],f=[],l=0;l<v.mixerGroup;l++)m.push(e.mixes[o+l].name);for(l=0;l<e.mixes[o].volumes.length;l+=v.faderGroup){for(var p=[],S=l;S<l+v.faderGroup;S++){for(var g=[],h=o;h<o+v.mixerGroup;h++)g.push(v.ProcessFader(e.mixes[h].volumes[S],S-l,h-o,o));p.push(g)}f.push(p)}c={name:"Mix:"+m.toString(),mixvol:f};a.push(c)}v.matrixSources=s,v.matrixRoutes=t,v.matrixMixVols=a}},v.TabSelected=function(e){var s=e*v.mixerGroup;r.refreshPool(s)},v.MatrixPoolCB={take:function(e,s,t){v.takeLinePool(e,s,t)},free:function(e,s,t){v.freeLinePool(e,s,t)}},v.ActivateCtrlsCB=function(e,s){v.callback(e,[s])},v.mixerGroup=parseInt(s.mixerGroup)||2,v.faderGroup=parseInt(s.faderGroup)||2,v.$watch("initvalues",function(){v.initvalues&&v.initWidget(v.initvalues)})}}}function scarlettMaster(e){return{templateUrl:"partials/scarlett-master.html",scope:{callback:"=",initvalues:"=",syncstatus:"="},restrict:"E",link:function(o,e,s){o.selectElem=e[0].firstChild,o.initWidget=function(e){var s;o.matrixPlaybackPool=[],o.clockSourcesPool=[],o.usbSourcesPool=[],o.idxcounter=1,o.switches=e.switches;for(var t=[],a=0;a<e.volumes.length;a++)t.push(o.ProcessVolume(e.volumes[a],a));o.volumes=t,s=e.sources[0].ctrl.enums;for(a=0;a<s.length;a++)o.matrixPlaybackPool.push({id:a,name:s[a],used:!1,options:[]});for(var r=[],a=0;a<e.sources.length;a++)r.push(o.ProcessSource(e.sources[a],o.matrixPlaybackPool));o.playSources=r,s=e.switches.clock.ctrl.enums;for(a=0;a<s.length;a++)o.clockSourcesPool.push({id:a,name:s[a],used:!1,options:[]});o.clockSources=o.ProcessSource(e.switches.clock,o.clockSourcesPool),s=e.switches.usb.ctrl.enums;for(a=0;a<s.length;a++)o.usbSourcesPool.push({id:a,name:s[a],used:!1,options:[]});o.usbSources=o.ProcessSource(e.switches.usb,o.usbSourcesPool),o.syncstatus=e.switches.syncon.value[0]},o.takeLinePool=function(e,s,t){t!==s.value&&o.callback([s.numid],[t])},o.freeLinePool=function(e,s,t){0!=t&&o.callback([s.numid],[0])},o.ProcessSource=function(e,s){var t=e.name.split(" ");return{label:t[1]+"-"+t[2],uid:"SrcId:"+e.numid,matrixLinesPool:s,lines:[{actif:e.actif,numid:e.numid,name:e.name+" numid="+e.numid,value:e.value[0],line:e}]}},o.ProcessVolume=function(e,s){return{channel:{idx:s,actif:e.actif,count:e.ctrl.count,numid:e.numid,label:e.name+" numid="+e.numid,uid:"VolId:"+e.numid},ctrl:{value:e.value,notLess:e.ctrl.min,notMore:e.ctrl.max,byStep:e.ctrl.step}}},o.ActivateCtrlsCB=function(e,s){o.callback([e],s)},o.switchid=s.id|"switch-"+parseInt(1e3*Math.random()),o.$watch("initvalues",function(){o.initvalues&&o.initWidget(o.initvalues)}),o.MatrixPoolCB={take:function(e,s,t){o.takeLinePool(e,s,t)},free:function(e,s,t){o.freeLinePool(e,s,t)}}}}}function ScarlettController(e,s,o,r,u,l,c){var x=this;x.SessionLabelPool=[],x.SessionLabelName={uid:"session",label:"current-session"},x.SessionLabelInfo={uid:"info",label:void 0},x.ResetSession=function(e){var s,t={request:"session-list",cardid:x.cardid},a=o.get("/jsonapi",{params:t});1<e&&(s=l.getNumids(),x.SendAlsaCtrlsCB(s,[0,0,0,0,0,0,0,0,0,0,0,0])),0<e&&(c.reset(),x.GetSndControls()),a.error(function(e,s,t){alert("Fail to upload session list [sndcard="+x.cardid+"from AlsaJsonGateway")}),a.success(function(e,s,t,a){"AJG_message"!==e.ajgtype?"AJG_sessions"==e.ajgtype?x.SessionsList=e.data:alert("AJM:FAIL ScarlettMixerController not a AJG_sessions record sndcard="+x.cardid+", response="+JSON.stringify(e)):"empty"==e.status?u.warning({message:e.info,delay:5e3}):u.error({message:e.info,delay:5e3})})},x.SessionLoad=function(a,n){var e,s;a&&(e={request:"session-load",cardid:x.cardid,session:a},(s=o.get("/jsonapi",{params:e})).error(function(e,s,t){alert("Fail to upload "+a+" from AlsaJsonGateway")}),s.success(function(e,s,t,a){if(x.sndcard=e.sndcard,"AJG_message"===e.ajgtype)return n.addClass("ajg-error"),n.removeClass("ajg-success"),void("empty"==e.status?u.warning({message:e.info,delay:5e3}):u.error({message:e.info,delay:5e3}));if("AJG_session"===e.ajgtype){if(n.removeClass("ajg-error"),n.addClass("ajg-success"),e.data)for(var r=0;r<e.data.length;r++){var o=e.data[r];l.setValue(o.numid,o.value)}if(e.info){var i=e.info;if("AJG_infos"!=i.ajgtype||!i.data)return void alert("AJM:FAIL ScarlettMixerController sndcard="+x.cardid+", invalid info="+JSON.stringify(i));for(r=0;r<i.data.length;r++){o=i.data[r];c.setValue(o.uid,o.label)}}}else alert("AJM:FAIL ScarlettMixerController sndcard="+x.cardid+", response="+JSON.stringify(e))}))},x.GetSndControls=function(){var e={request:"ctrl-get-all",cardid:x.cardid},s=o.get("/jsonapi",{params:e});s.error(function(e,s,t){alert("Fail to get SndCard's controls from AlsaJsonGateway")}),s.success(function(e,s,t,a){x.sndcard=e.sndcard;var r,o,i,n=[],u=[],l=[],c=[],d=[],m=[],f=[],p=[];if("AJG_ctrls"==e.ajgtype){for(var S=e.data,g=0;g<S.length;g++){var h,v=S[g],y=v.name.toLowerCase().split(" ");"input"===y[0]&&"capture"===y[3]&&n.push(v),"matrix"===y[0]&&"playback"==y[3]&&l.push(v),"matrix"===y[0]&&"mix"===y[2]&&"volume"==y[5]&&(h=y[3],u[h]||(u[h]={name:h.toUpperCase(),volumes:[]}),u[h].volumes.push(v)),"master"===y[0]&&"switch"===y[y.length-1]&&c.push(v),"master"===y[0]&&"volume"===y[y.length-1]&&f.push(v),"master"===y[0]&&"source"===y[y.length-3]&&"playback"===y[y.length-2]&&p.push(v),"input"===y[0]&&"pad"==y[2]&&m.push(v),"input"===y[0]&&"impedance"===y[2]&&d.push(v),"scarlett"===y[0]&&"usb-sync"===y[2]&&(r=v),"sample"===y[0]&&"sync"===y[2]&&(o=v),"sample"===y[0]&&"source"===y[2]&&(i=v)}var P=[];u&&Object.keys(u).forEach(function(e,s){P.push(u[e])},u),x.alsamixer={sources:n,routes:l,mixes:P},x.alsamaster={volumes:f,sources:p,switches:{master:c,pad:m,impedance:d,usb:r,syncon:o,clock:i}}}else alert("AJM:FATAL ScarlettMixerController sndcard="+x.cardid+", response="+JSON.stringify(e))})},x.SessionStore=function(){var e,s=c.getValue(x.SessionLabelName.uid);void 0===(t=c.getValue(x.SessionLabelInfo.uid))&&(e="AJG session created at "+(new Date).toLocaleString(),x.LabelByUid.setValue(x.SessionLabelInfo.uid,e));var t={ajgtype:"AJG_infos",data:c.getPool()},a={request:"session-store",cardid:x.cardid,session:s},r=o({method:"POST",url:"/jsonapi",params:a,data:JSON.stringify(t)});r.success(function(e,s,t,a){u.success({message:"Session Store on AlsaJsonGateway",delay:3e3})}),r.error(function(e,s,t){alert("Fail to Store Session onto AlsaJsonGateway status="+e)})},x.checkSyncStatus=function(){var e={request:"ctrl-get-one",cardid:x.cardid,numid:208};o.get("/jsonapi",{params:e}).success(function(e,s,t,a){!e.data||e.data[0]?x.BoardSyncStatus=!1:x.BoardSyncStatus=e.data[0].value[0]})},x.SendAlsaCtrlsCB=function(e,s){var t={request:"ctrl-set-many",cardid:x.cardid,value:JSON.stringify(s)},a=o({method:"POST",url:"/jsonapi",params:t,data:JSON.stringify(e)});207===e[0]&&r(x.checkSyncStatus,1e3),a.success(function(e,s,t,a){}),a.error(function(e,s,t){alert("Fail to send Card Controls to AlsaJsonGateway")})},x.init=function(){x.cardid=s.search().card,x.ResetSession(0),x.GetSndControls()},x.init()}ngapp.addDirective("scarlettCapture",["$log","CtrlByNumid",scarletteCapture]),ngapp.addDirective("scarlettMaster",["$log",scarlettMaster]),ngapp.addController("ScarlettMixerController",["$log","$location","$http","$timeout","Notification","CtrlByNumid","LabelByUid",ScarlettController]);